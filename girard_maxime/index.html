<html lang="en">

<head>
    <title> 3DWords </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <style>
        body {
            background-color: #193c6d;
            filter: progid: DXImageTransform.Microsoft.gradient(gradientType=1, startColorstr='#003073', endColorstr='#029797');
            background-image: url(//img.alicdn.com/tps/TB1d.u8MXXXXXXuXFXXXXXXXXXX-1900-790.jpg);
            background-size: 100%;
            background-image: -webkit-gradient(linear, 0 0, 100% 100%, color-stop(0, #003073), color-stop(100%, #029797));
            background-image: -webkit-linear-gradient(135deg, #003073, #029797);
            background-image: -moz-linear-gradient(45deg, #003073, #029797);
            background-image: -ms-linear-gradient(45deg, #003073 0, #029797 100%);
            background-image: -o-linear-gradient(45deg, #003073, #029797);
            background-image: linear-gradient(135deg, #003073, #029797);
            text-align: center;
            margin: 0px;
            overflow: hidden;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
    </style>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="js/three.js"></script>
    <script src="js/datGui.js"></script>
    <script src="js/jquery.js"></script>

    <script src="js/Detector.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/Projector.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/CanvasRenderer.js"></script>
<script>
        var container, stats;

        var camera, scene, renderer, controls;

        var group;

        var targetRotation = 0;
        var targetRotationOnMouseDown = 0;

        var raycaster;
        var mouse;

        window.words = [];
        window.definitions = [];
        window.totalWordGenerated = 0;

        var mouseX = 0;
        var mouseXOnMouseDown = 0;

        var intersected;

        var windowHalfX = window.innerWidth / 2;
        var windowHalfY = window.innerHeight / 2;
        var numberOfGroup = 0;

        var loader = new THREE.FontLoader();
        loader.load( 'fonts/exo.json', function ( font ) {

            init( font );
            window.font = font; // create global var
            animate();

        } );
    

        function init( font ) {

            var FizzyText = function() {
                this.word = 'Bad';
                this.category = "Synonyms";
                this.generate = function(){
                    createWords(font, this.word, this.category);
                };
                this.reset = function(){
                    destroyWords();
                };
            };

            window.settings = new FizzyText(); // make settings global
            var gui = new dat.GUI();

            gui.add(settings, 'word');
            gui.add(settings, 'category', [ 'Synonyms', 'Antonyms', 'Rhymes', 'Suggestions', 'SoundLike' ] );

            gui.add(settings, 'generate');

            gui.add(settings, 'reset');

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            container = document.createElement( 'div' );
            document.body.appendChild( container );

            scene = new THREE.Scene();

            createWords(font, settings.word, settings.category); // Create initial word

            camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 1000 );
            camera.position.set( 0, 100, 400 );
            
            renderer = new THREE.CanvasRenderer({ alpha: true }); // make canvas transparent
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            container.appendChild( renderer.domElement );

            controls = new THREE.OrbitControls(camera,renderer.domElement);

            stats = new Stats();
            container.appendChild( stats.dom );

            window.addEventListener( 'resize', onWindowResize, false );
            window.addEventListener( 'mousedown', onDocumentMouseDown, false );
            window.addEventListener( 'touchstart', onDocumentTouchStart, false );
            window.addEventListener( 'mousemove', onDocumentMouseMove, false );
        }


        function createWords(font, word, category){
            var firstWordGeometry = new THREE.TextGeometry( word, {
                font: font,
                size: 20,
                height: 3,
                curveSegments: 1,
            });

            firstWordGeometry.computeBoundingBox();
            var centerOffset = -0.5 * ( firstWordGeometry.boundingBox.max.x - firstWordGeometry.boundingBox.min.x );



            var material = new THREE.MultiMaterial( [
                new THREE.MeshBasicMaterial( { color: Math.random() * 0xffffff, overdraw: 0.5 } ),
                new THREE.MeshBasicMaterial( { color: 0x000000, overdraw: 0.8 } )
            ] );

            if(numberOfGroup >= 3) {
                numberOfGroup = 0;
                destroyWords();
            }

            group = new THREE.Group();
            numberOfGroup++;
            
            // Creating firstWord
            var firstMesh = new THREE.Mesh( firstWordGeometry, material );

            firstMesh.position.x = 0;
            firstMesh.position.y = 0 - (numberOfGroup * 80);
            firstMesh.position.z = 0 + 5;

            firstMesh.rotation.x = 0;

            // API calls by category
            if(category == "Synonyms")
                url = "https://api.datamuse.com/words?max=10&md=d&rel_syn=";
            else if(category == "Antonyms")
                url = "https://api.datamuse.com/words?max=10&rel_ant=";
            else if(category == "Suggestions")
                url = "https://api.datamuse.com/sug?max=10&s=";
            else if(category == "SoundLike")
                url = "https://api.datamuse.com/words?max=10&sl=";
            else   
                url = "https://api.datamuse.com/words?max=10&rel_rhy=";

            group.add( firstMesh );
            $.ajax({
                url: url + word,
                type: 'GET', 
                dataType: 'json',
                success: function(data) { 
                    for(var i = 0; i < data.length; i++)
                    {
                        // Resize text by score word 
                        if(data[i].score >= 10 &&  data[i].score < 150)
                            var fontSize = 7;
                        else if(data[i].score >= 150 &&  data[i].score < 500)
                            var fontSize = 9;                        
                        else if(data[i].score >= 500 &&  data[i].score <= 1000)
                            var fontSize = 10;
                        else if(data[i].score >= 1000 &&  data[i].score <= 2000)
                            var fontSize = 11;
                        else if(data[i].score > 2000)
                            var fontSize = 12;

                        var otherWordsGeometry = new THREE.TextGeometry( data[i].word, {
                            font: font,
                            size: fontSize,
                            height: 1, // weight 
                            curveSegments: 1
                        });

                        otherWordsGeometry.computeBoundingBox();

                        var mesh = new THREE.Mesh( otherWordsGeometry, material );
                        mesh.name = data[i].word;
                        
                        if(i == 0){ // Placing the first word after selected word
                            mesh.position.x = firstMesh.position.x + (word.length * 20);
                            mesh.position.y = firstMesh.position.y + 5 * (i + 1);
                            mesh.position.z = firstMesh.position.z;   

                            var startPoint = new THREE.Vector3(firstMesh.position.x, firstMesh.position.y, firstMesh.position.z);
                            var endPoint   = new THREE.Vector3(mesh.position.x, mesh.position.y, mesh.position.z);
                            var direction = new THREE.Vector3().subVectors(endPoint, startPoint).normalize();
                            var arrow = new THREE.ArrowHelper(direction, startPoint, startPoint.distanceTo(endPoint), 0xCC0000 );
                            scene.add(arrow);

                        }
                        else{ // Placing others word
                            mesh.position.x = previousMesh.position.x + (previousWord.length * 10);   
                            mesh.position.y = firstMesh.position.y + 5 * (i + 1);
                            mesh.position.z = previousMesh.position.z - 20;     

                            var lineGeometry = new THREE.Geometry();
                            lineGeometry.vertices.push( new THREE.Vector3(previousMesh.position.x, previousMesh.position.y, previousMesh.position.z), new THREE.Vector3(mesh.position.x, mesh.position.y, mesh.position.z) );
                            lineGeometry.computeLineDistances();
                            var lineMaterial = new THREE.LineBasicMaterial( { color: 0xCCCCCC } );
                            var line = new THREE.Line( lineGeometry, lineMaterial );
                            scene.add(line);             
                        }

                        var previousMesh = mesh;
                        var previousWord = data[i].word;

                        window.words.push(mesh);

                        var wordDefinitions = { name: data[i].word, definitions: data[i].defs};

                        window.definitions.push(wordDefinitions);

                        group.add( mesh );
                    }
                    window.totalWordGenerated += data.length;
                    $("#totalWords").text(window.totalWordGenerated + " in total");
                    $("#currentWords").text(window.words.length + " in the scene");
                },
                error: function(err) { 
                    alert(err); 
                }
            });

            scene.add( group );
        }

        function onWindowResize() {

            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

        }

        // Delete every words generation
        function destroyWords(){
            scene.children.slice().forEach(function(obj) { 
                window.words = [];
                window.definitions = [];
                $("#currentWords").text("0 in the scene");
                if(obj.type == "Group" || obj.type == "Line" || obj.type == "Object3D")
                    scene.remove(obj); 
            })
        }

        function animate() {

            requestAnimationFrame( animate );

            render();
            stats.update();

        }

        function render() {

            renderer.render( scene, camera );

            raycaster.setFromCamera( mouse, camera );

            $.each(window.words, function(index, value) { // Make word look at camera
                value.lookAt(camera.position);
            }); 

            var intersects = raycaster.intersectObjects( words );

            if ( intersects.length > 0 )
                {
                    $.each(window.definitions, function(index, value) {
                        if(value.name == intersects[0].object.name){
                            $("#wordDefTitle").text(value.name + " definitions");
                            for(var i = 0; i < 3; i++){
                                var splittedText = value.definitions[i].split("\t");
                                $("#definitionPanel").show();
                                if(splittedText[0] == "n"){
                                    $("#type" + i).text("name");
                                }
                                else if(splittedText[0] == "n"){
                                    $("#type" + i).text("verb");
                                }
                                else{
                                    $("#type" + i).text(splittedText[0]);
                                }
                                $("#def" + i).text(splittedText[1]);
                            }

                        }
                    }); 

                    intersected = intersects[0];
                    intersects[0].object.scale.x = 1.5;
                    intersects[0].object.scale.y = 1.5;
                    intersects[0].object.scale.z = 1.5;
                } 
                else 
                {
                    if(intersected != null)
                    {
                        intersected.object.scale.x = 1;
                        intersected.object.scale.y = 1;
                        intersected.object.scale.z = 1;
                    }
                }
            }

        function onDocumentTouchStart( event ) {

            event.preventDefault();

            event.clientX = event.touches[0].clientX;
            event.clientY = event.touches[0].clientY;
            onDocumentMouseDown( event );

        }

        function onDocumentMouseDown( event ) {

            if(event.which == 1){ // Only for left mouse button
                mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
                mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;

                raycaster.setFromCamera( mouse, camera );

                var intersects = raycaster.intersectObjects( words );

                if ( intersects.length > 0 ) {                              
                    createWords(window.font, intersects[0].object.name, window.settings.category);
                }
            }
        }

        function onDocumentMouseMove( event ) 
        {
            mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;
        }

    </script>
</head>

<body>
    <style>
        .demo-card-square.mdl-card {
            width: 400px;
        }
        .demo-card-square > .mdl-card__title {
            color: #fff;
            background:
               #46B6AC;
        }
        .mdl-card__title-text {
            position: relative;
            bottom: -5px;
        }
        .demo-list-two {
            width: 300px;
            margin-top: 0;
        }
        .mdl-list__item{
            padding: 8px;
        }
        .definition{
            font-style: italic;
        }
        .type{
            font-weight: 600;
        }
        .mdl-list__item-primary-content{
            text-align: left;
        }
    </style>
    <div class="demo-card-square mdl-card mdl-shadow--2dp" style="position: absolute; bottom: 0; right: 100px; display: none;" id="definitionPanel">
        <div class="mdl-card__title mdl-card--expand" style="max-height: 50px;">
            <h2 class="mdl-card__title-text" id="wordDefTitle">Definitions</h2>
        </div>
        <div class="mdl-card__supporting-text" style="padding-top: 0;">
            <div class="demo-list-action mdl-list">
                <div class="mdl-list__item">
                    <span class="mdl-list__item-primary-content">
                         <span id="type0" class="type"></span>
                    </span>
                    <span class="mdl-list__item-secondary-content">
                        <span id="def0" class="definition"></span>
                    </span>
                </div>
                <div class="mdl-list__item">
                    <span class="mdl-list__item-primary-content">
                         <span id="type1" class="type"></span>
                    </span>
                   <span class="mdl-list__item-secondary-content">
                        <span id="def1" class="definition"></span>
                    </span>
                </div>
                <div class="mdl-list__item">
                    <span class="mdl-list__item-primary-content">
                        <span id="type2" class="type"></span>
                    </span>
                    <span class="mdl-list__item-secondary-content">
                        <span id="def2" class="definition"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="demo-card-square mdl-card mdl-shadow--2dp" style="position: absolute; bottom: 0; left: 100px; max-width: 270px; max-height: 225px" id="wordsInfoPanel">
        <div class="mdl-card__title mdl-card--expand" style="max-height: 50px;">
            <h2 class="mdl-card__title-text" id="wordDefTitle">Informations</h2>
        </div>
        <div class="mdl-card__supporting-text" style="padding-top: 0;">
            <div class="demo-list-action mdl-list">
                <ul class="demo-list-two mdl-list">
                    <li class="mdl-list__item mdl-list__item--two-line">
                        <span class="mdl-list__item-primary-content">
                        <i class="material-icons mdl-list__item-avatar">grade</i>
                        <span>Words generated</span>
                        <span class="mdl-list__item-sub-title" id="totalWords"></span>
                        </span>
                        <span class="mdl-list__item-secondary-content">
                    </li>
                    <li class="mdl-list__item mdl-list__item--two-line">
                        <span class="mdl-list__item-primary-content">
                        <i class="material-icons mdl-list__item-avatar">timeline</i>
                        <span>Current Words</span>
                        <span class="mdl-list__item-sub-title" id="currentWords"></span>
                        </span>

                    </li>
                </ul>
            </div>
        </div>
    </div>
</body>

</html>